---
title: "Hydrological modeling with SacsmaR package"
author: "M. Umit Taner"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
    toc: true
    number_sections: true
---

# Introduction

This vignette demonstrates the main functionality of the sacsmaR package. We first
begin with introducing the input files required for the functions. Next, we introduce
each different module included (PET, SNOW17, SAC-SMA, Lohmann routing). Finally, we'll show
the usage of the hydrologigical simulation function, which is a wrapper for the individual 
modules.

```{r setup, include = FALSE}

#Rmarkdown setup
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

#Required packages
library(sacsmaR)
library(dplyr)
library(lubridate)
library(ggplot2)
```


# Input-data

```{r data, cache = TRUE}

# We'll use the St. Croix Watershed data, which is included in this package  
data(stcroix)

# Grid info file, consists of latitude, longitude, area, elevation, and 
# flowlegth information. Each row belongs to a different HRU

grid_info <- stcroix$hru.info
hru_lat     <- unlist(grid_info[,1], use.names = FALSE)
hru_lon     <- unlist(grid_info[,2], use.names = FALSE)
hru_area    <- unlist(grid_info[,3], use.names = FALSE)
hru_elev    <- unlist(grid_info[,4], use.names = FALSE)
hru_flowlen <- unlist(grid_info[,5], use.names = FALSE)

# Calibration parameters for the hydrology, pet, snow, and routing modules.
# Each row belongs to a different HRU

hru_par   <- stcroix$hru.par
par_sacsma   <- hru_par[,1:16]    # Sac-sma parameters
par_petHamon <- hru_par[,17]      # PET (Hamon) parameters
par_snow17   <- hru_par[,18:27]   # Snow module parameters
par_routLah  <- hru_par[,28:31]   # Routing model parameters

# Climate input data: time-series of precipitation and temperature for each HRU.

hru_prcp  <- stcroix$prcp.grid
hru_tavg  <- stcroix$tavg.grid

# Finally, lets set the simulation period 
str_date <- as.Date("1970/01/1") #starting date
end_date <- as.Date("1980/12/31") # endind date
seq_date <- seq.Date(str_date, end_date, by = "day") #date sequence
sim_date <- seq.Date(str_date, end_date, by = "day") #date sequence
sim_per  <- length(sim_date) #number of days in the simulation period
jday <- lubridate::yday(sim_date) # day of the year in (1-365 format)

```


# Illustration of modules

## PET module

```{r pet, cache = TRUE}

# Simulate daily potential evapotranspiration for a single HRU based on Hamon equation.
# The pet equation takes four inputs: par (pet parameter), tavg (time-series of average 
# temperature), latitude information, and jday (day of the year from 1 to 365)

pet <- hamon(par = par_petHamon[1], 
             tavg = hru_tavg[[1]],
             lat = hru_lat[[1]], 
             jday = jday)

df <- data_frame(date = seq_date, pet = pet)
ggplot(df, aes(date, pet)) + geom_line() + labs(x = "", y = "PET (mm/day)")

```

## SNOW module

```{r snow17, cache = TRUE}

# The snow module is based on SNOW17 model

snowMelt <- snow17(par = par_snow17[1,],
                   prcp = hru_prcp[[1]],
                   tavg = hru_tavg[[1]],
                   elev = hru_elev[[1]],
                   jday = jday)

```

## Runoff module

```{r sacsma, cache = TRUE}
### SAC MODULE
simflow <- sacsma(par = par_sacsma[1,],
                  prcp = hru_prcp[[1]],
                  pet = pet, lat = hru_lat[1], elev = hru_elev[1])

```

## Routing module

```{r lohmann, cache = TRUE}

# Routing module is based on lohmann model 

flow <- lohmann(par = par_routLah[1,], flength = hru_flowlen[1])

```

# Hydrology simulation 

```{r hydrosim, cache = TRUE}

hru_par <- hru_par %>% as.matrix()

par_sacsma   = hru_par[,1:16] 
par_petHamon = hru_par[,17]  
par_snow17   = hru_par[,18:27] 
par_routLah  = hru_par[,28:31] 

flowR <- hydroSim(
  par.hamon    = hru_par[,17],
  par.snow17   = hru_par[,18:27],
  par.sacsma   = hru_par[,1:16],
  par.lohmann  = hru_par[,28:31],
  tavg.grid    = hru_tavg,
  prcp.grid    = hru_prcp,
  lat.grid     = hru_lat,
  elev.grid    = hru_elev,
  area.grid    = hru_area, 
  flength.grid = hru_flowlen,
  jday = jday)

```